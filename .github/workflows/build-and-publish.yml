name: Build & Publish

on:
  push:
    tags:
      - 'v*' # Trigger only on tags like v0.3.1

env:
  ITCH_TARGET: dalysoftware/veil-of-cataclysm

jobs:
  windows:
    name: Windows - Veil.Desktop
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - name: Compute version
        shell: pwsh
        run: |
          $VERSION = ($env:GITHUB_REF -replace '^refs/tags/', '') -replace '^v',''
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Version: $VERSION"

      - name: Restore
        run: dotnet restore ./Veil.Desktop/Veil.Desktop.csproj -r win-x64

      - name: Publish
        shell: pwsh
        run: |
          $stageDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/win-x64/itch"
          if (Test-Path $stageDir) { Remove-Item $stageDir -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null

          dotnet publish ./Veil.Desktop/Veil.Desktop.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -o $stageDir `
            --no-restore `
            -p:Version=$env:VERSION `
            -p:FileVersion=$env:VERSION `
            -p:AssemblyVersion=$env:VERSION

          # Create Game/ folder for distribution
          $gameDir = Join-Path $stageDir "Game"
          New-Item -ItemType Directory -Force -Path $gameDir | Out-Null
          Get-ChildItem $stageDir | Where-Object { $_.Name -ne "Game" } | Move-Item -Destination $gameDir

          # Launcher.bat at the root
          $exeName = "Veil.Desktop.exe"
          $launcherPath = Join-Path $stageDir "Launcher.bat"
          @"
          :: Launcher.bat - simple shortcut to run $exeName
          cd Game
          start """" $exeName
          "@ | Out-File -Encoding ASCII $launcherPath

      - name: Install butler
        uses: ./.github/actions/install-butler

      - name: Push to itch.io
        shell: pwsh
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        run: |
          $stageDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/win-x64/itch"
          butler push "$stageDir" "${{ env.ITCH_TARGET }}:win-x64" --userversion "$env:VERSION"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Veil-win-x64
          path: artifacts/win-x64/itch/

  web:
    name: Web - Veil.Web
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Compute version
        shell: pwsh
        run: |
          $VERSION = ($env:GITHUB_REF -replace '^refs/tags/', '') -replace '^v',''
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Version: $VERSION"

      - name: Install WASM build tools
        working-directory: Veil.Web
        run: dotnet workload install wasm-tools-net8

      - name: Restore
        working-directory: Veil.Web
        run: dotnet restore Veil.Web.csproj

      - name: Publish
        working-directory: Veil.Web
        shell: pwsh
        run: |
          $publishDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/web/publish"
          $stageDir   = Join-Path $env:GITHUB_WORKSPACE "artifacts/web/itch"

          if (Test-Path $publishDir) { Remove-Item $publishDir -Recurse -Force }
          if (Test-Path $stageDir)   { Remove-Item $stageDir -Recurse -Force }

          New-Item -ItemType Directory -Force -Path $publishDir | Out-Null
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null

          dotnet publish Veil.Web.csproj -c Release -o $publishDir --no-restore

          Copy-Item -Path (Join-Path $publishDir "wwwroot\*") -Destination $stageDir -Recurse -Force

      - name: Install butler
        uses: ./.github/actions/install-butler

      - name: Push to itch.io
        shell: pwsh
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        run: |
          $stageDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/web/itch"
          butler push "$stageDir" "${{ env.ITCH_TARGET }}:web" --userversion "$env:VERSION"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Veil-web
          path: artifacts/web/itch/